(e=>{let r=0,t=null,l=null,o="",s=!1,a=!1,d=null,n=2,i={};const c={};let f=null,p=!1,h=!1;const m=()=>{const r=wp.media.view.MediaFrame.Post;wp.media.view.MediaFrame.Post=r.extend({initialize(...e){r.prototype.initialize.apply(this,e),this.on("content:render",this.contentRender,this)},contentRender(r){if(null!==r){const t=r.toolbar.secondary.$el.find("select.attachment-filters");if(t.length>2){const r=parseInt(100/t.length)-2;e(t).each((t,l)=>{e(l).css("width",`calc(${r}% - 12px)`)})}}}});const t=wp.media.view.AttachmentFilters.extend({id:"media-attachment-rl-folders-filters",className:"attachment-filters attachment-rl-folders-filter",change(...e){wp.media.view.AttachmentFilters.prototype.change.apply(this,e),null!==l&&l.controller.states.get("library").get("library").observe(wp.Uploader.queue)},createFilters(){const r={};let t=0;const l={text:rlFoldersArgs.root,priority:1,props:{[rlFoldersArgs.taxonomy]:0,force_update:0,include_children:!1}};if(""!==rlFoldersArgs.terms){const o=e(e.parseHTML(rlFoldersArgs.terms)).find("option");o.length>0&&(r[0]=l,o.each((l,o)=>{t=parseInt(e(o).val()||0),t=0===t?"all":t,n=l+2;const s=e(o).html();e(o).text(s),r[t]={text:e(o).text(),priority:n,props:{[rlFoldersArgs.taxonomy]:t,force_update:0,include_children:!1}}}))}else r.all={text:rlFoldersArgs.all_terms,priority:1,props:{[rlFoldersArgs.taxonomy]:"all",force_update:0,include_children:!0}},r[0]=l;this.filters=r}}),o=wp.media.view.AttachmentsBrowser;wp.media.view.AttachmentsBrowser=wp.media.view.AttachmentsBrowser.extend({createToolbar(){if(o.prototype.createToolbar.call(this),d=this,"rl-remote-library"!==this.model.get("id")){if("string"==typeof rlFoldersArgs.selected_term&&""!==rlFoldersArgs.selected_term&&"all"!==rlFoldersArgs.selected_term){const e="0"===rlFoldersArgs.selected_term?0:parseInt(rlFoldersArgs.selected_term,10);isNaN(e)||this.collection.props.set({[rlFoldersArgs.taxonomy]:e,include_children:!1},{silent:!0})}this.toolbar.set("RLfoldersFilterLabel",new wp.media.view.Label({value:"Filter by folder",attributes:{for:"media-attachment-rl-folders-filters"},priority:-75}).render()),this.toolbar.set("RLfoldersAttachmentFilters",new t({controller:this.controller,model:this.collection.props,priority:-75}).render())}}});const s=wp.media.view.AttachmentCompat;wp.media.view.AttachmentCompat=wp.media.view.AttachmentCompat.extend({initialize(){s.prototype.initialize.call(this);const r=this.model.saveCompat;this.model.saveCompat=(t,l)=>{const o=e(".rl-media-tag-select2"),s=o.select2("data"),a=[];for(let e=0;e<s.length;e++)a.push(s[e].id);return t[o.attr("name")]=a.join(","),r.call(this.model,t,l)}},render(){s.prototype.render.call(this),e(".select2-container--open").remove(),setTimeout(_,5)},save(r){e(r.target).hasClass("select2-search__field")||s.prototype.save.call(this,r)}})},g=()=>{const r=e("#rl-folders-tree-root"),t=r.find(".rl-folders-sidebar-toggle"),l=r.find(".rl-folders-sidebar-separator"),o=r.find(".rl-folders-header-add-new-folder"),s="rlFoldersSidebarCollapsed",a="rlFoldersSidebarWidth";if(0===r.length||0===t.length||0===l.length)return;const d=(e,r)=>{const t=parseInt(e,10);return Number.isNaN(t)?r:t},n=(e,r,t)=>Math.min(t,Math.max(r,e)),i=e("body").hasClass("rtl");let c=d(rlFoldersArgs.sidebar_width_min,220),f=d(rlFoldersArgs.sidebar_width_max,420),p=d(rlFoldersArgs.sidebar_width_default,272);const h=n(d(rlFoldersArgs.sidebar_width_collapsed,0),0,Math.max(c,0));if(c>f){const e=c;c=f,f=e}p=n(p,c,f);const m=(e,r)=>{try{window.localStorage.setItem(e,r)}catch(t){}},g=e=>{try{return window.localStorage.getItem(e)}catch(r){return null}};let u=p;const _=e("body").get(0);r.get(0).style.setProperty("--rl-folders-sidebar-width-collapsed",`${h}px`);const w=()=>{const e=r.hasClass("collapsed"),t=e?h:u,o=e?h:c,s=e?h:f;l.attr({"aria-valuenow":t,"aria-valuemin":o,"aria-valuemax":s})},y=(e,t=!0)=>{u=n(e,c,f),(e=>{r.get(0).style.setProperty("--rl-folders-sidebar-width",`${e}px`),_&&_.style.setProperty("--rl-folders-sidebar-width",`${e}px`)})(u),w(),t&&m(a,String(u))},b=(e,l=!0,o=!0)=>{r.toggleClass("collapsed",e),t.attr("aria-expanded",e?"false":"true"),w(),l&&m(s,e?"1":"0"),o&&v()};l.attr({"aria-valuemin":c,"aria-valuemax":f});const j=d(g(a),p),A="1"===g(s);y(j,!1),b(A,!1,!1),t.on("click",e=>{e.preventDefault(),e.stopPropagation(),b(!r.hasClass("collapsed"),!0)}),o.on("click",t=>{t.preventDefault();const l=e(".rl-folders-add-new-folder").first();return r.hasClass("collapsed")&&b(!1,!0),0===l.length||l.hasClass("disabled-link")||l.trigger("click"),!1});let F=!1,x=0,C=u;const k=e=>{if("number"==typeof e.clientX)return e.clientX;if(e.originalEvent){if(e.originalEvent.touches&&e.originalEvent.touches.length>0)return e.originalEvent.touches[0].clientX;if(e.originalEvent.changedTouches&&e.originalEvent.changedTouches.length>0)return e.originalEvent.changedTouches[0].clientX}return 0},$=()=>{F&&(F=!1,e("body").removeClass("rl-folders-sidebar-resizing"),e(document).off(".rlFoldersSidebarResize"),y(u,!0),b(!1,!0))},S=e=>{if(!F)return;e.cancelable&&e.preventDefault();const r=k(e);y(C+(r-x)*(i?-1:1),!1),b(!1,!1,!1)},N=t=>{e(t.target).closest(".rl-folders-sidebar-toggle").length>0||"mousedown"===t.type&&0!==t.button||(t.cancelable&&t.preventDefault(),F=!0,x=k(t),C=u,r.hasClass("collapsed")&&b(!1,!0),e("body").addClass("rl-folders-sidebar-resizing"),window.PointerEvent&&"pointerdown"===t.type?(e(document).on("pointermove.rlFoldersSidebarResize",S),e(document).on("pointerup.rlFoldersSidebarResize pointercancel.rlFoldersSidebarResize",$)):(e(document).on("mousemove.rlFoldersSidebarResize touchmove.rlFoldersSidebarResize",S),e(document).on("mouseup.rlFoldersSidebarResize touchend.rlFoldersSidebarResize touchcancel.rlFoldersSidebarResize",$)))};window.PointerEvent?l.on("pointerdown",N):l.on("mousedown touchstart",N),l.on("dblclick",r=>{e(r.target).closest(".rl-folders-sidebar-toggle").length>0||(r.preventDefault(),y(p,!0),b(!1,!0))}),l.on("keydown",e=>{let t=u,l=!0;switch(e.key){case"ArrowLeft":t+=i?10:-10;break;case"ArrowRight":t+=i?-10:10;break;case"ArrowUp":t+=10;break;case"ArrowDown":t-=10;break;case"Home":t=c;break;case"End":t=f;break;default:l=!1}l&&(e.preventDefault(),r.hasClass("collapsed")&&b(!1,!0),y(t,!0),v())})},u=()=>{if("upload.php"!==rlFoldersArgs.page||"undefined"==typeof wp||void 0===wp.media||void 0===wp.media.model||void 0===wp.media.model.Attachment)return;const e=wp.media.model.Attachment.prototype;if(!e||e.rlFoldersSyncWrapped||"function"!=typeof e.sync)return;const r=e.sync;e.rlFoldersSyncWrapped=!0,e.sync=function(e,t,l){const o=r.apply(this,arguments),s="delete"===e,a="update"===e&&"function"==typeof this.hasChanged&&this.hasChanged("status");return s||a?(o&&"function"==typeof o.done?o.done(()=>{z()}):z(),o):o}};e(()=>{if(u(),void 0!==wp.Uploader){const r=wp.Uploader.prototype.init;e.extend(wp.Uploader.prototype,{init(){"function"==typeof r&&r.apply(this,arguments),this.uploader&&!this.uploader.rlFoldersUploadEventsBound&&(this.uploader.rlFoldersUploadEventsBound=!0,this.uploader.bind("BeforeUpload",(e,r)=>{L(e,r)}),this.uploader.bind("FileUploaded",(e,r,t)=>{M(r,t)}),this.uploader.bind("UploadComplete",()=>{z(),B()}))}})}else"undefined"!=typeof uploader&&(uploader.rlFoldersUploadEventsBound||(uploader.rlFoldersUploadEventsBound=!0,uploader.bind("BeforeUpload",(e,r)=>{L(e,r)}),uploader.bind("FileUploaded",(e,r,t)=>{M(r,t)}),uploader.bind("UploadComplete",()=>{z(),B()})));if("media"===rlFoldersArgs.page)m(),e(document).on("change","#media-attachment-rl-folders-filters",r=>{e("#rl_folders_upload_files").val(e(r.currentTarget).val())}),e("body").removeClass("rl-folders-root-pending");else if("media-new.php"===rlFoldersArgs.page)e("body").removeClass("rl-folders-root-pending");else try{const d=[],n=["sort","dnd"];o=e("body").hasClass("rl-folders-upload-grid-mode")?"grid":"list",(()=>{if("upload.php"!==rlFoldersArgs.page)return!1;const r=e("#wpbody-content"),t=e("body"),l=(e,r)=>{const t=parseInt(e,10);return Number.isNaN(t)?r:t},o=(e,r,t)=>Math.min(t,Math.max(r,e));let s=l(rlFoldersArgs.sidebar_width_min,220),a=l(rlFoldersArgs.sidebar_width_max,420),d=l(rlFoldersArgs.sidebar_width_default,272);if(s>a){const e=s;s=a,a=e}d=o(d,s,a);let n=d;try{n=l(window.localStorage.getItem("rlFoldersSidebarWidth"),d)}catch(c){}const i=o(n,s,a);t.length>0&&t.get(0).style.setProperty("--rl-folders-sidebar-width",`${i}px`),0===e("#rl-folders-tree-root").length&&r.length>0?(r.before(rlFoldersArgs.template),e("body").removeClass("rl-folders-root-pending").addClass("rl-folders-root-layout-active")):e("#rl-folders-tree-root").length>0?e("body").removeClass("rl-folders-root-pending").addClass("rl-folders-root-layout-active"):(e("body").hasClass("rl-folders-upload-grid-mode")?e("#wp-media-grid").length>0&&(e("#wp-media-grid").append(rlFoldersArgs.template),e("body").removeClass("rl-folders-root-pending")):e("#posts-filter").length>0&&(e("#posts-filter").before(rlFoldersArgs.template),e("body").removeClass("rl-folders-root-pending")),e(".sidebar.sidebar-secondary").length>0&&0===e("#rl-folders-tree-root").length&&(e(".sidebar.sidebar-secondary").append(rlFoldersArgs.template),e("body").removeClass("rl-folders-root-pending")))})(),"list"===o?(e(".filter-items .actions").append('<span class="spinner"></span>'),j("list")):m(),g(),rlFoldersArgs.wholerow&&n.push("wholerow"),R(),e("#rl-folders-tree").jstree({core:{check_callback:(e,r,t,l,o)=>!("move_node"===e&&"#"===t.parent&&"all"===t.a_attr["data-term_id"]),multiple:!1,expand_selected_onload:!1,worker:!1,animation:150},dnd:{is_draggable:e=>"#"!==e[0].parent},sort(e,r){return"j1_1"===e?-1:this.get_text(e).toLowerCase()>this.get_text(r).toLowerCase()?1:-1},plugins:n}),e("#rl-folders-tree").jstree("set_theme",rlFoldersArgs.theme),e(document).on("click",".jstree-anchor",Q),e(document).on("click",".rl-folders-add-new-folder",()=>{const r=e("#rl-folders-tree").jstree().get_selected().toString(),t=e(`#${r}_anchor`).data("term_id");let l=r;if("all"===t){const e=A(0);e.length>0&&(l=e.parent().attr("id"))}const s=e("#rl-folders-tree").jstree("create_node",l,rlFoldersArgs.new_folder,"inside",()=>{},!0);return e("#rl-folders-tree").jstree("deselect_node",r),"list"===o&&(a=!0),e("#rl-folders-tree").jstree("select_node",s,!0,!0),e("#rl-folders-tree").jstree("select_node",s,!0,!0),e("#rl-folders-tree").jstree("open_node",l,()=>{const r=e(`#${s}_anchor`),t=r.html().match("<i(?:.+)?/i>")[0],o=e("#rl-folders-tree").jstree(!0).get_json("#",{flat:!0});e(document).off("click",".jstree-anchor"),e.each(o,(r,t)=>{0==t.state.selected&&e("#rl-folders-tree").jstree("disable_node",t.id)}),e(".rl-folders-add-new-folder").hide(),e(".rl-folders-save-new-folder, .rl-folders-cancel-new-folder").show(),e(".rl-folders-rename-folder, .rl-folders-delete-folder, .rl-folders-expand-folder, .rl-folders-collapse-folder").addClass("disabled-link"),r.hide().after(`<span id="${l}_span">${t}<input id="rl-folders-enter-new-folder" type="text" value="${rlFoldersArgs.new_folder}" placeholder="" data-term_id="${parseInt(r.data("term_id"))}" data-nof="0" /></span>`),e("#rl-folders-enter-new-folder").trigger("select"),e("#rl-folders-enter-new-folder").on("keyup",r=>{13===r.which?W(!0,parseInt(e(`#${l}_anchor`).data("term_id"))):27===r.which&&X(!0,!0)})},e("#rl-folders-tree").jstree().settings.core.animation),!1}),e(document).on("click",".rl-folders-rename-folder",()=>{const r=e("#rl-folders-tree").jstree().get_selected().toString(),t=e(`#${r}_anchor`),l=t.data("term_id");if("all"===l||0===l)return!1;const o=t.html().match("(<i(?:.+)?/i>)(.+)"),s=o[2].split(" "),a=s.pop().match(/\d+/)[0],d=s.join(" "),n=e("#rl-folders-tree").jstree(!0).get_json("#",{flat:!0});e(document).off("click",".jstree-anchor"),e.each(n,(r,t)=>{0==t.state.selected&&e("#rl-folders-tree").jstree("disable_node",t.id)}),e(".rl-folders-rename-folder").hide(),e(".rl-folders-save-folder, .rl-folders-cancel-folder").show(),e(".rl-folders-add-new-folder, .rl-folders-delete-folder, .rl-folders-expand-folder, .rl-folders-collapse-folder").addClass("disabled-link"),t.hide().after(`<span id="${r}_span">${o[1]}<input id="rl-folders-enter-folder" type="text" value="" placeholder="" data-term_id="${parseInt(l)}" data-nof="${a}" /></span>`);const i=e(`span#${r}_span input`);return i.val(d),i[0].placeholder=d,e("#rl-folders-enter-folder").trigger("select"),e("#rl-folders-enter-folder").on("keyup",e=>{13===e.which?W(!1,0):27===e.which&&X(!1,!1)}),!1}),e(document).on("click",".rl-folders-save-folder",()=>(W(!1,0),!1)),e(document).on("click",".rl-folders-save-new-folder",()=>(W(!0,parseInt(e(`#${e("#rl-folders-tree").jstree().get_selected().toString()}_anchor`).data("term_id"))),!1)),e(document).on("click",".rl-folders-cancel-folder",()=>(X(!1,!1),!1)),e(document).on("click",".rl-folders-cancel-new-folder",()=>(X(!0,!0),!1)),e(document).on("click",".rl-folders-delete-folder",r=>{if(!e(r.currentTarget).hasClass("disabled-link")&&confirm(rlFoldersArgs.remove_children?rlFoldersArgs.delete_terms:rlFoldersArgs.delete_term)){q(!0);const r=e("#rl-folders-tree").jstree().get_selected().toString(),t=parseInt(e(`#${r}_anchor`).data("term_id"));e.post(ajaxurl,{action:"rl-folders-delete-term",term_id:t,children:rlFoldersArgs.remove_children?1:0,nonce:rlFoldersArgs.nonce}).done(t=>{try{if(t.success){const l=e("#rl-folders-tree").jstree("get_parent",r);H(e(t.data).find("option"),""),rlFoldersArgs.remove_children||e("#rl-folders-tree").jstree("is_leaf",r)||e("#rl-folders-tree").jstree("open_node",r,()=>{e("#rl-folders-tree").jstree("get_children_dom",r).each((r,t)=>{J(e(t).attr("id"),l)})},e("#rl-folders-tree").jstree().settings.core.animation),e("#rl-folders-tree").jstree("delete_node",r),e("#rl-folders-tree").jstree("select_node",l),e("#media-attachment-rl-folders-filters").val(e(`#${l}_anchor`).data("term_id")).trigger("change"),z(),C(),v()}}catch(l){}q(!1)}).fail(()=>{q(!1)})}return!1}),e(document).on("click",".rl-folders-expand-folder",r=>(e(r.currentTarget).hasClass("disabled-link")||e("#rl-folders-tree").jstree("open_all",e("#rl-folders-tree").jstree().get_selected(),e("#rl-folders-tree").jstree().settings.core.animation),!1)),e(document).on("click",".rl-folders-collapse-folder",r=>(e(r.currentTarget).hasClass("disabled-link")||e("#rl-folders-tree").jstree("close_all",e("#rl-folders-tree").jstree().get_selected(),e("#rl-folders-tree").jstree().settings.core.animation),!1)),e("#rl-folders-tree").on("select_node.jstree",()=>{const r=e("#rl-folders-tree").jstree().get_selected().toString(),t=e(`#${r}_anchor`).data("term_id");N(t),"list"!==o?(w("grid"),w("list"),y(t),$(r,t)):a?a=!1:window.location.replace(e(`#${r}_anchor`).attr("href"))}),e("#rl-folders-tree").on("rename_node.jstree",(e,r)=>{i.create&&(r.node.a_attr["data-term_id"]=i.response.term_id,r.node.a_attr.href=i.response.url,i={})}),e("#rl-folders-tree").on("ready.jstree",(r,l)=>{"list"===o&&b("list"),t=new PerfectScrollbar("#rl-folders-tree",{wheelSpeed:3,wheelPropagation:!0,minScrollbarLength:30}),e.jstree.core.prototype.edit=()=>{e(".rl-folders-rename-folder").trigger("click")},w("grid"),w("list"),k(),I(),C(),p=!0,e("body").removeClass("rl-folders-root-pending")}),e("#rl-folders-tree").on("close_all.jstree",()=>{C(),v(),"list"===o&&b("list")}),e("#rl-folders-tree").on("open_all.jstree",()=>{C(),v(),"list"===o&&b("list")}),e("#rl-folders-tree").on("close_node.jstree",()=>{C(),v(),"list"===o&&b("list")}),e("#rl-folders-tree").on("open_node.jstree",()=>{C(),v(),"grid"===o?b("grid"):"list"===o&&b("list")}),e(document).on("ajaxComplete",(e,t,s)=>{const a=K("action",s),d=K("changes[status]",s);"rl-folders-move-attachments"===a?b(o):"query-attachments"===a?(b("grid"),j("grid"),null===l&&(l=wp.media.frame.content.get(),r=0)):"delete-post"!==a&&("save-attachment"!==a||"trash"!==d&&"inherit"!==d)||z()}),e(document).on("change","#media-attachment-rl-folders-filters",r=>{if("list"===o)return;const t=e("#rl-folders-tree").jstree().get_selected().toString();if(void 0===d[t])d[t]=!0;else{const t=e(r.currentTarget).val();l.collection.props.set("force_update",+new Date),e(r.currentTarget).val(t)}}),e("#rl-folders-tree").on("move_node.jstree",(r,t)=>{if(s)return s=!1,!1;q(!0),e.post(ajaxurl,{action:"rl-folders-move-term",term_id:parseInt(t.node.a_attr["data-term_id"]),parent_id:parseInt(e(`#${t.parent}_anchor`).data("term_id")),nonce:rlFoldersArgs.nonce}).done(r=>{try{r.success?(H(e(r.data).find("option"),""),e("#rl-folders-tree").jstree("open_node",t.parent,"",e("#rl-folders-tree").jstree().settings.core.animation)):J(t.node.id,t.old_parent,t.old_position)}catch(l){J(t.node.id,t.old_parent,t.old_position)}q(!1)}).fail(()=>{J(t.node.id,t.old_parent,t.old_position),q(!1)})}),e(document).on("click",".select-mode-toggle-button",()=>{l.controller.isModeActive("select")?j("grid"):e("#media-attachment-rl-folders-filters").hide()})}finally{e("body").removeClass("rl-folders-root-pending")}e(document).on("change","#rl_folders_upload_files",t=>{r=parseInt(e(t.currentTarget).val()),isNaN(r)&&(r=0)}),"media"!==rlFoldersArgs.page&&e(document).on("keydown",r=>{("INPUT"!==r.target.nodeName&&"TEXTAREA"!==r.target.nodeName||r.target.readOnly||r.target.disabled)&&27===r.keyCode&&e(".media-modal-close").trigger("click")})});const _=()=>{const r=e(".rl-media-tag-select2");0===r.length||r.hasClass("select2-hidden-accessible")||(e("div.attachment-info").off("scroll"),e("div.media-sidebar").off("scroll"),r.select2({closeOnSelect:!0,scrollAfterSelect:!1,allowClear:!1,debug:!1,multiple:!0,width:"100%",minimumInputLength:2,dropdownCssClass:"rl-media-tag-select2-dropdown",ajax:{delay:200,url:ajaxurl,data:e=>({action:"ajax-tag-search",tax:"rl_media_tag",q:e.term}),processResults:e=>{const r=[];e=e.split(/[\r\n]+/).filter(Boolean);for(let t=0;t<e.length;t++)r[t]={id:e[t],text:e[t]};return{results:r}}}}))},w=r=>{const t=e(`.view-switch > a.view-${r}`),l=t.prop("href"),o=l.split("upload.php")[1],s=G(rlFoldersArgs.taxonomy,o);let a=e(`#${e("#rl-folders-tree").jstree().get_selected().toString()}_anchor`).data("term_id");0===a&&(a=-1),"list"===r&&"all"===a&&(a=0),""===s?t.prop("href",`${l}&${rlFoldersArgs.taxonomy}=${a}`):t.prop("href",l.replace(new RegExp(`${rlFoldersArgs.taxonomy}=(-?[0-9]+|all)`,"g"),`${rlFoldersArgs.taxonomy}=${a}`))},y=e=>{if("upload.php"!==rlFoldersArgs.page||"grid"!==o)return;if(void 0===window.history||"function"!=typeof window.history.replaceState)return;const r=F(e);let t=r;"all"===r?t="0":"0"===r&&(t="-1");const l=window.location.href;let s="";if(""===G(rlFoldersArgs.taxonomy,window.location.search)){const e=-1===l.indexOf("?")?"?":"&";s=`${l}${e}${rlFoldersArgs.taxonomy}=${t}`}else s=l.replace(new RegExp(`([?&])${rlFoldersArgs.taxonomy}=(-?[0-9]+|all)`,"g"),`$1${rlFoldersArgs.taxonomy}=${t}`);window.history.replaceState(window.history.state,document.title,s)},v=()=>{setTimeout(()=>{null!==t&&t.update()},200)},b=r=>{const t=e("#rl-folders-tree").jstree("get_selected",!1);let o;if(rlFoldersArgs.wholerow){const r=e("div.jstree-wholerow.jstree-wholerow-clicked");void 0!==r.droppable("instance")&&r.droppable("destroy"),o=e("#rl-folders-tree .jstree-wholerow:not(:eq(0))").not(`#${t} .jstree-wholerow-clicked`)}else{const r=e(`#${t}_anchor`);void 0!==r.droppable("instance")&&r.droppable("destroy"),o=e(`#rl-folders-tree li a.jstree-anchor:not(:eq(0),#${t}_anchor)`)}"list"===r?o.droppable({activeClass:"rl-folders-state-active",hoverClass:"rl-folders-state-hover",accept:"#the-list tr",tolerance:"pointer",drop:(r,t)=>{const l=e(r.target).closest("li").find("a.jstree-anchor"),o=[],s=e('#the-list .check-column input[type="checkbox"]:checked');let a=e(),d=-1,n=parseInt(l.data("term_id"));const i=parseInt(G(rlFoldersArgs.taxonomy,window.location.search),10);if(isNaN(i)){a=e(`#${e("#rl-folders-tree").jstree().get_selected().toString()}_anchor`);const r=a.data("term_id");d="all"===r?-1:parseInt(r),isNaN(d)&&(d=-1)}else 0===i?(d=-1,a=e('#rl-folders-tree .jstree-anchor[data-term_id="all"]').first()):-1===i?(d=0,a=e('#rl-folders-tree .jstree-anchor[data-term_id="0"]').first()):(d=i,a=e(`#rl-folders-tree .jstree-anchor[data-term_id="${i}"]`).first());isNaN(n)&&(n=-1),q(!0),0===s.length?o.push(t.draggable.find('.check-column input[type="checkbox"]').val()):s.each((r,t)=>{o.push(parseInt(e(t).val()))}),e.post(ajaxurl,{action:"rl-folders-move-attachments",attachment_ids:o,old_term_id:d,new_term_id:n,nonce:rlFoldersArgs.nonce}).done(r=>{try{if(r.success){if(-1!==d){for(let t=0;t<r.data.attachments.success.length;t++){const l=e(`#post-${r.data.attachments.success[t]}`);l.fadeOut("fast",()=>{l.remove(),0===e("#the-list tr").length&&e("#the-list").append(rlFoldersArgs.no_media_items)})}a.length>0&&D(a,r.data,!1)}D(l,r.data,!0)}}catch(t){}q(!1)}).fail(()=>{q(!1)})}}):o.droppable({activeClass:"rl-folders-state-active",hoverClass:"rl-folders-state-hover",accept:"li.attachment",tolerance:"pointer",drop:(r,t)=>{const o=e(r.target).closest("li").find("a.jstree-anchor"),s=e(`#${e("#rl-folders-tree").jstree().get_selected().toString()}_anchor`),a=s.data("term_id"),d="all"===a?-1:parseInt(a),n=[];q(!0),e(".media-frame").hasClass("mode-edit")?n.push(parseInt(t.draggable.data("id"))):e("ul.attachments > li.selected").each((r,t)=>{n.push(parseInt(e(t).data("id")))}),e.post(ajaxurl,{action:"rl-folders-move-attachments",attachment_ids:n,old_term_id:d,new_term_id:parseInt(o.data("term_id")),nonce:rlFoldersArgs.nonce}).done(r=>{try{if(r.success){if(-1!==d){for(let t=0;t<r.data.attachments.success.length;t++){const l=e(`ul.attachments li[data-id="${r.data.attachments.success[t]}"]`);l.fadeOut("fast",()=>{l.remove(),0===e("ul.attachments li").length&&e(".no-media").removeClass("hidden")})}D(s,r.data,!1)}D(o,r.data,!0),l.controller.deactivateMode("select").activateMode("edit")}}catch(t){}q(!1)}).fail(()=>{q(!1)})}})},j=r=>{if("grid"===r){let r=0;e(".media-frame-content ul.attachments li").draggable({helper:()=>{let t=1;return t="grid"===o?e(".media-frame").hasClass("mode-edit")?1:e("ul.attachments li.selected").length:e('#the-list .check-column input[type="checkbox"]:checked').length,r=t,`<div class="rl-folders-dragged-item"><div class="dashicons dashicons-media-default"></div><span>${t}</span></div>`},drag:()=>{if(0===r)return!1},appendTo:"body",distance:3,cursor:"move",cursorAt:{top:20,left:20},containment:"#wpwrap",revert:"invalid",cancel:"input, label, a, .check-column, .column-primary a, .row-actions, .toggle-row",zIndex:999})}else e("#the-list tr").draggable({helper:()=>{let r=e('#the-list .check-column input[type="checkbox"]:checked').length;return 0===r&&(r=1),`<div class="rl-folders-dragged-item"><div class="dashicons dashicons-media-default"></div><span>${r}</span></div>`},appendTo:"body",distance:3,cursor:"move",cursorAt:{top:20,left:20},containment:"#wpwrap",revert:"invalid",cancel:"input, label, .row-actions, .toggle-row",zIndex:999})},A=r=>{if(0===e("#rl-folders-tree").length)return e();const t=parseInt(r),l="all"===r?"all":isNaN(t)?"0":String(t);return e("#rl-folders-tree .jstree-anchor").filter((r,t)=>String(e(t).data("term_id"))===l).first()},F=e=>{if("all"===e)return"all";const r=parseInt(e,10);return Number.isNaN(r)?"0":String(r)},x=()=>{const e="string"==typeof rlFoldersArgs.taxonomy&&""!==rlFoldersArgs.taxonomy?rlFoldersArgs.taxonomy:"default";return`rlFoldersTreeOpenTerms:${"string"==typeof window.location.pathname?window.location.pathname:""}:${e}`},C=()=>{if("upload.php"!==rlFoldersArgs.page||0===e("#rl-folders-tree").length)return;if(h)return;const r=e("#rl-folders-tree").jstree(!0);if(!r||"function"!=typeof r.get_state)return;const t=r.get_state(),l=t&&t.core&&Array.isArray(t.core.open)?t.core.open:[],o=[],s={};e.each(l,(e,t)=>{const l=r.get_node(t),a=l&&l.a_attr&&Object.prototype.hasOwnProperty.call(l.a_attr,"data-term_id")?F(l.a_attr["data-term_id"]):"";""!==a&&"all"!==a&&void 0===s[a]&&(s[a]=!0,o.push(a))});try{window.localStorage.setItem(x(),JSON.stringify(o))}catch(a){}},k=()=>{if("upload.php"!==rlFoldersArgs.page||0===e("#rl-folders-tree").length)return;const r=(()=>{if("upload.php"!==rlFoldersArgs.page)return null;let r=null;try{r=window.localStorage.getItem(x())}catch(s){return null}if(null===r)return null;if("string"!=typeof r)return null;let t=[];try{t=JSON.parse(r)}catch(s){return null}if(!Array.isArray(t))return null;const l=[],o={};return e.each(t,(e,r)=>{const t=F(r);""!==t&&"all"!==t&&void 0===o[t]&&(o[t]=!0,l.push(t))}),l})();if(null===r)return;const t=e("#rl-folders-tree").jstree(!0);if(!t||!t.settings||!t.settings.core||"function"!=typeof t.get_json||"function"!=typeof t.close_all||"function"!=typeof t.open_node||"function"!=typeof t.get_node)return;const l=t.get_json("#",{flat:!0}),o={};Array.isArray(l)&&e.each(l,(e,r)=>{if(!(r&&r.id&&r.a_attr&&Object.prototype.hasOwnProperty.call(r.a_attr,"data-term_id")))return;const t=F(r.a_attr["data-term_id"]);""!==t&&"all"!==t&&(o[t]=r.id)});const s=t.settings.core.animation;t.settings.core.animation=0,h=!0;try{t.close_all()}finally{h=!1}if(0===r.length)return void(t.settings.core.animation=s);const a=[],d={};e.each(r,(e,r)=>{const l=o[r],s=l?t.get_node(l):null;s&&s.id&&void 0===d[s.id]&&(d[s.id]=!0,a.push({node_id:s.id,depth:Array.isArray(s.parents)?s.parents.length:0}))}),0!==a.length?(a.sort((e,r)=>e.depth===r.depth?0:e.depth>r.depth?1:-1),e.each(a,(e,r)=>{t.open_node(r.node_id,null,0)}),t.settings.core.animation=s):t.settings.core.animation=s},$=(t,l)=>{const o=F(l);e("#rl_folders_upload_files").val("all"===o?0:o),r=parseInt(o),isNaN(r)&&(r=0),"all"===o?(e(".rl-folders-add-new-folder").removeClass("disabled-link"),e(".rl-folders-rename-folder, .rl-folders-delete-folder").addClass("disabled-link")):"0"===o?(e(".rl-folders-rename-folder, .rl-folders-delete-folder").addClass("disabled-link"),e(".rl-folders-add-new-folder").removeClass("disabled-link")):e(".rl-folders-add-new-folder, .rl-folders-rename-folder, .rl-folders-delete-folder").removeClass("disabled-link"),e("#rl-folders-tree").jstree("is_leaf",t)?e(".rl-folders-expand-folder, .rl-folders-collapse-folder").addClass("disabled-link"):e(".rl-folders-expand-folder, .rl-folders-collapse-folder").removeClass("disabled-link")},S=()=>{const r=e("#rl-folders-tree").jstree().get_selected().toString();if(!r)return;const t=e(`#${r}_anchor`).data("term_id");$(r,t)},N=(r,t=!1)=>{if("upload.php"!==rlFoldersArgs.page)return;if(!p&&!t)return;const l=F(r);e.post(ajaxurl,{action:"rl-folders-select-term",term_id:l,nonce:rlFoldersArgs.nonce})},I=()=>{if("upload.php"!==rlFoldersArgs.page||0===e("#rl-folders-tree").length)return;if(void 0===rlFoldersArgs.selected_term)return;const r=F(rlFoldersArgs.selected_term);if(""===r||"all"===r)return;const t=e("#rl-folders-tree").jstree().get_selected().toString(),l=t?F(e(`#${t}_anchor`).data("term_id")):"all";if(l===r)return void("grid"===o&&(S(),y(l)));const s=A(r);if(0===s.length){if(N("all",!0),"grid"===o){const r=e("#media-attachment-rl-folders-filters");r.length>0&&r.val("all").trigger("change")}return}const d=s.parent().attr("id");if(d&&(t&&e("#rl-folders-tree").jstree("deselect_node",t),"list"===o&&(a=!0),e("#rl-folders-tree").jstree("select_node",d,!0,!0),"grid"===o)){const r=e("#media-attachment-rl-folders-filters"),t=F(s.data("term_id"));r.length>0&&r.val(t),S()}},T=(e,r)=>{if(!e||0===e.length)return;const t=e.parent();if(0===t.length)return;const l=t.attr("data-jstree");let o={};if("string"==typeof l&&""!==l)try{o=JSON.parse(l)}catch(s){o={}}o.selected=!!r,t.attr("data-jstree",JSON.stringify(o))},R=()=>{if("upload.php"!==rlFoldersArgs.page||0===e("#rl-folders-tree").length)return;if(void 0===rlFoldersArgs.selected_term)return;const r=F(rlFoldersArgs.selected_term);if(""===r||"all"===r)return;const t=A(r);0!==t.length&&(e("#rl-folders-tree .jstree-anchor").each((r,t)=>{T(e(t),!1)}),T(t,!0))},O=e=>{if(!e||0===e.length)return null;const r=e.text().trim().match(/^(.*)\s\((\d+)\)$/);return null===r?null:{name:r[1],count:parseInt(r[2])}},E=(r,t)=>{if(!r||0===r.length)return;const l=O(r),o=parseInt(t);null===l||isNaN(o)||e("#rl-folders-tree").jstree("rename_node",r.parent().attr("id"),`${l.name} (${Math.max(0,o)})`)},P=(e,r)=>{const t=A(e),l=O(t),o=parseInt(r);null===l||isNaN(o)||E(t,l.count+o)},U=()=>{"upload.php"===rlFoldersArgs.page&&void 0!==rlFoldersArgs.nonce&&0!==e("#rl-folders-tree").length&&e.post(ajaxurl,{action:"rl-folders-get-counters",nonce:rlFoldersArgs.nonce}).done(r=>{try{r.success&&r.data&&r.data.counters&&(t=r.data.counters)&&"object"==typeof t&&e.each(t,(e,r)=>{const t=A(e);t.length>0&&E(t,r)})}catch(l){}var t})},z=(r=250)=>{if("upload.php"!==rlFoldersArgs.page||0===e("#rl-folders-tree").length)return;const t=parseInt(r,10),l=Number.isNaN(t)?250:Math.max(0,t);null!==f&&clearTimeout(f),f=setTimeout(()=>{f=null,U()},l)},L=(e,t)=>{const l=(()=>{const e=parseInt(r);return isNaN(e)?0:e})();e&&e.settings&&e.settings.multipart_params&&(e.settings.multipart_params.rl_folders_upload_files_term_id=l),t&&t.settings&&t.settings.multipart_params&&(t.settings.multipart_params.rl_folders_upload_files_term_id=l),t&&void 0!==t.id&&(c[t.id]=l)},M=(e,r)=>{if(!e||void 0===e.id)return;const t=Object.prototype.hasOwnProperty.call(c,e.id)?parseInt(c[e.id]):0,l=isNaN(t)?0:t;(e=>{if(!e)return!1;if("string"==typeof e.response)try{const r=JSON.parse(e.response);return!(!r||!r.success)}catch(r){return!1}return void 0!==e.success&&!!e.success})(r)&&(P("all",1),P(l,1)),delete c[e.id]},B=()=>{e.each(c,e=>{delete c[e]})},D=(e,r,t)=>{const l=r&&r.attachments&&Array.isArray(r.attachments.success)?r.attachments.success.length:0,o=r&&r.attachments&&Array.isArray(r.attachments.duplicated)?r.attachments.duplicated.length:0,s=t?l-o:-l,a=e.data("term_id");P(a,s)},q=r=>{r?"list"===o?e(".filter-items .actions").find(".spinner").addClass("is-active"):e(".media-toolbar-secondary").find(".spinner").addClass("is-active"):"list"===o?e(".filter-items .actions").find(".spinner").removeClass("is-active"):e(".media-toolbar-secondary").find(".spinner").removeClass("is-active")},J=(r,t,l)=>{s=!0,e("#rl-folders-tree").jstree("move_node",r,t,l)},X=(r,t)=>{const l="#"+e("#rl-folders-tree").jstree().get_selected().toString(),s=e("#rl-folders-tree").jstree(!0).get_json("#",{flat:!0});if(e(r?".rl-folders-add-new-folder":".rl-folders-rename-folder").show(),e(r?".rl-folders-save-new-folder, .rl-folders-cancel-new-folder":".rl-folders-save-folder, .rl-folders-cancel-folder").hide(),e(r?".rl-folders-rename-folder, .rl-folders-delete-folder":".rl-folders-add-new-folder, .rl-folders-delete-folder").removeClass("disabled-link"),r&&t){const r=e("#rl-folders-tree").jstree("get_parent",l);e("#rl-folders-tree").jstree("delete_node",l),"list"===o&&(a=!0),e("#rl-folders-tree").jstree("select_node",r)}else e("#rl-folders-tree").jstree("is_leaf",l)||e(".rl-folders-expand-folder, .rl-folders-collapse-folder").removeClass("disabled-link"),e(l+"_span").remove(),e(l+"_anchor").show();e.each(s,(r,t)=>{e("#rl-folders-tree").jstree("enable_node",t.id)}),b(o),e(document).on("click",".jstree-anchor",Q)},W=(r,t)=>{const l=e(r?"#rl-folders-enter-new-folder":"#rl-folders-enter-folder"),s=e("#rl-folders-tree").jstree().get_selected().toString(),a=l.val().trim(),c=l.data("nof");let f=0;if(r||(f=parseInt(l.data("term_id")),isNaN(f)&&(f=0)),""===a||a===l.attr("placeholder"))return X(r,!0),!1;q(!0),e.post(ajaxurl,r?{action:"rl-folders-add-term",parent_id:t,name:a,nonce:rlFoldersArgs.nonce}:{action:"rl-folders-rename-term",term_id:f,name:a,nonce:rlFoldersArgs.nonce}).done(t=>{try{t.success?(r?(e("#media-attachment-rl-folders-filters").append('<option value="'+t.data.term_id+'">'+t.data.name+"</option>"),null!==d&&(d.toolbar.get("RLfoldersAttachmentFilters").filters[t.data.term_id]={text:t.data.name,priority:n+1,props:{[rlFoldersArgs.taxonomy]:t.data.term_id,force_update:0,include_children:!1}})):(e('#media-attachment-rl-folders-filters option[value="'+f+'"]').text(t.data.name),e('#media-attachment-rl-folders-filters option[value="'+f+'"]').prop("selected",!0)),i={response:t.data,create:r},e("#rl-folders-tree").jstree("rename_node",s,t.data.name+" ("+c+")"),e("#rl-folders-tree").jstree("sort",s,!1),r&&(e("#"+s+"_anchor").attr("data-term_id",t.data.term_id).attr("href",t.data.url),e("#media-attachment-rl-folders-filters").val(t.data.term_id).trigger("change"),"list"===o&&window.location.replace(t.data.url)),H(e(t.data.select).find("option"),r?t.data.term_id:f,r)):X(r,!0),X(r,!1)}catch(l){X(r,!0)}q(!1)}).fail(()=>{q(!1),X(r,!0)})},H=(t,l,o=!1)=>{const s=e("#rl_folders_upload_files");if(s.empty().append(t).val(l),o){const e=parseInt(s.val(),10);r=Number.isNaN(e)?0:e}},Q=r=>{e("#media-attachment-rl-folders-filters").val(e(r.currentTarget).data("term_id")).trigger("change")},G=(e,r)=>{const t="string"==typeof r?r:String(r||""),l=t.indexOf("?"),o=l>=0?t.substring(l+1):t,s="&"===o.charAt(0)?o.substring(1):o;if("undefined"!=typeof URLSearchParams)try{const r=new URLSearchParams(s).get(e);if(null!==r)return r}catch(d){}const a=new RegExp("[?&]"+e.replace(/[\[\]]/g,"\\$&")+"(=([^&#]*)|&|#|$)").exec("&"+t);return a&&a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):""},K=(e,r)=>{if(!r||"object"!=typeof r)return"";let t="";return"string"==typeof r.data?t=G(e,r.data):r.data&&"object"==typeof r.data&&(t=((e,r)=>{if(!e||"object"!=typeof e)return"";if(Object.prototype.hasOwnProperty.call(e,r)){const t=e[r];return null==t?"":String(t)}const t=r.match(/[^\[\]]+/g);if(!t||0===t.length)return"";let l=e;for(let o=0;o<t.length;o++){if(!l||"object"!=typeof l||!Object.prototype.hasOwnProperty.call(l,t[o]))return"";l=l[t[o]]}return null==l?"":String(l)})(r.data,e)),""===t&&"string"==typeof r.url&&(t=G(e,r.url)),t}})(jQuery);
